<!DOCTYPE html>
<html class="x-admin-sm" lang="en" xmlns:th="http://www.w3.org/1999/html">

<head>
    <link rel="stylesheet" href="../css/font.css">
    <link rel="stylesheet" href="../css/xadmin.css">
    <link rel="stylesheet" href="../layui/css/layui.css">
    <link rel="stylesheet" href="../css/JCheck.css">
    <script type="text/javascript" src="../js/jqery/jquery-3.4.1.js"></script>
    <script type="text/javascript" src="../layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../js/xadmin.js"></script>
    <script type="text/javascript" src="../js/cookie.js"></script>
    <script src="../js/JCheck.js"></script>
    <script src="../js/echarts/echarts.min.js?v=1.0.4" charset="utf-8"></script>
    <style>
        body{overflow-y: scroll;}
        .layadmin-homepage-pad-hor {
            padding-left: 15px;
            padding-right: 15px;
            border-bottom: 15px;
            color: #999;
            text-indent: 20px;
            font-size: 24px;
        }
    </style>
</head>
<!--<script type="text/html" id="toolbarDemo">-->
<!--    <div class="layui-btn-container ">-->
<!--        <button class="layui-btn layui-btn-lg layui-btn-normal" id="addBtn" onclick="x_admin_show('创建问题词条','../system/auditManagement/plan-management-add.html','600','460')">新增</button>-->
<!--        <button class="layui-btn layui-btn-lg layui-btn-danger layui-btn-xs layui-hide" id="delBtn"  lay-event="del" ><i class="layui-icon"></i>删除</button>-->
<!--        <button class="layui-btn layui-btn-lg layui-btn-normal layui-hide" id="submitReportBtn" lay-event="editContent">提交报告</button>-->
<!--    </div>-->
<!--</script>-->
<body th:fragment="pagination">
    <div class="x-body">
        <fieldset class="layui-elem-field">
            <legend style="font-size: 16px;font-weight:bold">整体概况</legend>
            <div class="layui-field-box">
                <div class="layui-col-md12">
                    <div class="layui-card">
                        <div class="layui-card-body">
                            <div class="layui-carousel x-admin-carousel x-admin-backlog" lay-anim=""
                                lay-indicator="inside" lay-arrow="none" style="width: 100%; height: 90px;">
                                <div carousel-item="">
                                    <ul class="layui-row layui-col-space10 layui-this">
                                        <li class="layui-col-xs2">
                                            <a href="javascript:;" class="x-admin-backlog-body" onclick="openPlanCheckList('all')">
                                                <h5 style="font-size: large;">总项目</h5>
                                                <p style="margin-left: 5px;margin-top: 10px;"><cite  id="planSum">0</cite></p>
                                            </a>
                                        </li>
                                        <li class="layui-col-xs2">
                                            <a href="javascript:;" class="x-admin-backlog-body" onclick="openPlanCheckList('done')">
                                                <h5 style="font-size: large;">已完成</h5>
                                                <p style="margin-left: 5px;margin-top: 10px;"><cite  id="finishCount">0</cite></p>
                                            </a>
                                        </li>
                                        <li class="layui-col-xs2">
                                            <a href="javascript:;" class="x-admin-backlog-body" onclick="openPlanCheckList('todo')" >
                                                <h5 style="font-size: large;">未完成</h5>
                                                <p style="margin-left: 5px;margin-top: 10px;"><cite id="nofinishCount">0</cite></p>
                                            </a>
                                        </li>
                                        <li class="layui-col-xs2">
                                            <a href="javascript:;" class="x-admin-backlog-body" onclick="openPlanCheckList('delay')">
                                                <h5 style="font-size: large;">延期项目</h5>
                                                <p style="margin-left: 5px;margin-top: 10px;"><cite  id="timeoutCount">0</cite></p>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="layui-row layui-col-space15">
                <div class="layui-col-md4">
                    <div class="layui-card">
                        <div class="layui-card-header" >整改情况</div>
                        <div class="layui-card-body">
                            <div class="layui-carousel layadmin-carousel layadmin-shortcut" lay-anim="" lay-indicator="inside" lay-arrow="none" style="width: 100%; height: 280px;"
                            id="rectifySituation">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-col-md4">
                    <div class="layui-card">
                        <div class="layui-card-header" >项目类型</div>
                        <div class="layui-card-body">
                            <div class="layui-carousel layadmin-carousel layadmin-shortcut" lay-anim="" lay-indicator="inside" lay-arrow="none" style="width: 100%; height: 280px;">
                                <table class="layui-table layuiadmin-page-table" lay-skin="line">
                                    <thead>
                                    <tr>
                                        <th>排名</th>
                                        <th>类型</th>
                                        <th>项目数</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>1</td>
                                        <td>类型3</td>
                                        <td>10</td>
                                    </tr>
                                    <tr>
                                        <td>2</td>
                                        <td>类型2</td>
                                        <td>9</td>
                                    </tr>
                                    <tr>
                                        <td>3</td>
                                        <td>类型3</td>
                                        <td>8</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layui-col-md4">
                    <div class="layui-card">
                        <div class="layui-card-header" style="font-size: 16px;font-weight:bold">超时项目</div>
                        <div class="layui-card-body">
                            <div class="layui-carousel layadmin-carousel layadmin-shortcut" lay-anim="" lay-indicator="inside" lay-arrow="none" style="width: 100%; height: 280px;"
                                 id="timeoutProject">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </fieldset>
        <fieldset class="layui-elem-field" >
            <legend style="font-size: 16px;font-weight:bold">关注问题</legend>
            <xblock>
                <button class="layui-btn layui-btn-lg layui-btn-normal layui-hide" id="addBtn" onclick="x_admin_show('创建问题词条','../system/auditManagement/plan-management-add.html','600','460')">新增</button>
                <button class="layui-btn layui-btn-lg layui-btn-danger layui-btn-xs layui-hide" id="delBtn"  lay-event="del" ><i class="layui-icon"></i>删除</button>
                <button class="layui-btn layui-btn-lg layui-btn-normal layui-hide" id="submitReportBtn" lay-event="editContent">提交报告</button>
            </xblock>
            <table class="layui-table x-admin" id="test" lay-data="{toolbar: '#toolbarDemo',id:'test'}" lay-filter="test">

            </table>
        </fieldset>
        <fieldset class="layui-elem-field" >
            <legend style="font-size: 16px;font-weight:bold">汇总报告</legend>
            <div id="reportContent" class="layadmin-homepage-pad-hor">
                fsjdfksdjflsjdfpiuwepirlkdh螺丝扣搭街坊士大夫的数量较少的接下来看fsjdfksdjflsjdfpiuwepirlkdh螺丝扣搭街坊士大夫的数量较少的接下来看
                    fsjdfksdjflsjdfpiuwepirlkdh螺丝扣搭街坊士大夫的数量较少的接下来看fsjdfksdjflsjdfpiuwepirlkdh螺丝扣搭街坊士大夫的数量较少的接下来看fsjdfksdjflsjdfpiuwepirlkdh螺丝扣搭街坊士大夫的数量较少的接下来看fsjdfksdjflsjdfpiuwepirlkdh螺丝扣搭街坊士大夫的数量较少的接下来看fsjdfksdjflsjdfpiuwepirlkdh螺丝扣搭街坊士大夫的数量较少的接下来看fsjdfksdjflsjdfpiuwepirlkdh螺丝扣搭街坊士大夫的数量较少的接下来看fsjdfksdjflsjdfpiuwepirlkdh螺丝扣搭街坊士大夫的数量较少的接下来看fsjdfksdjflsjdfpiuwepirlkdh螺丝扣搭街坊士大夫的数量较少的接下来看fsjdfksdjflsjdfpiuwepirlkdh螺丝扣搭街坊士大夫的数量较少的接下来看
            </div>
        </fieldset>
    </div>

</body>

<script>
    //查询项目统计数
    $.ajax({
        url: "/audit-api/planStatistic/countOfPlan",
        dataType: "json",
        type: "post",
        data:{},
        success: function (resp) {
            if (resp && 0 == resp.code) {
                let data = resp.data;
                $("#planSum").html(data.planSum);
                $("#finishCount").html(data.finishCount);
                $("#nofinishCount").html(data.nofinishCount);
                $("#timeoutCount").html(data.timeoutCount);
            }
        }
    });
    PercentPie.prototype.init = function () {
        var _that = this;
        var option = {
            backgroundColor: _that.backgroundColor,
            color: _that.color,
            legend: {
                data: _that.legendData,
                icon: 'rect',
                top: 100,
                right: '14.17004%',
                itemGap: 35,
                itemWidth: 10,
                itemHeight: 10,
                orient: 'vertical',
                textStyle: {
                    padding: [0, 0, 0, 5],
                }
            },
            tooltip: {
                trigger: 'item',
                formatter: "{b} : <br>{c}({d}%)",
                backgroundColor: 'rgba(0,0,0,0.3)', // 背景
                padding: [8, 10], //内边距
                extraCssText: 'box-shadow: 0 0 3px rgba(255, 255, 255, 0.87);', //添加阴影
            },
            series: [{
                type: 'pie',
                radius: ['60%', '75%'],
                center: ['40%', '60%'],
                label: {
                    normal: {
                        show: false,
                        position: 'center',
                        textStyle: {
                            fontSize: _that.fontSize,
                            fontWeight: 'bold'
                        },
                        formatter: '{b}\n{c}个'
                    }
                },
                data:_that.data
            }]
        };
        echarts.init(_that.domEle).setOption(option);
    };

    $.ajax({
        url: "/audit-api/planStatistic/questionStatistic",
        dataType: "json",
        type: "post",
        data:{"rectifySituationId":"all"},
        success: function (res) {
            var statisticData = res.data.statisticData;
            var data1=[],legendData=[];

            if(statisticData){
                statisticData.forEach((item, index)=>{
                    var iiitem = {}
                    iiitem.name=item.name;
                    iiitem.value=item.value;
                    if(index==1){
                        iiitem.label = {normal: {show: true}};
                    }
                    data1.push(iiitem);
                    legendData.push(item.name);
                });
                var option1 = {
                        value: 38, //百分比,必填
                        name: '', //必填
                        title: '',
                        backgroundColor: null,
                        color: ['#289df5', '#ff5050'],
                        fontSize: 16,
                        domEle: document.getElementById("rectifySituation"), //必填
                        data :data1,
                        legendData:legendData,
                    },

                    percentPie1 = new PercentPie(option1);
                percentPie1.init();
            }
        }
    });

    var option2 = {
            value: 20, //百分比,必填
            name: '123', //必填
            title: '',
            backgroundColor: null,
            color: ['#289df5', '#ff5050'],
            fontSize: 16,
            domEle: document.getElementById("timeoutProject"), //必填
            data :[{
                value: "5",
                name: "已超时",
                label: {
                    normal: {
                        show: true
                    }
                }
            },
                {
                    value: 10,
                    name: '未超时'
                }
            ],
            legendData:["已超时","未超时"],
        },
    percentPie2 = new PercentPie(option2);
    percentPie2.init();

    function PercentPie(option) {
        this.backgroundColor = option.backgroundColor || '#fff';
        this.color = option.color || ['#EAEAEA', '#6CAEE8'];
        this.fontSize = option.fontSize || 12;
        this.domEle = option.domEle;
        this.value = option.value;
        this.name = option.name;
        this.data = option.data;
        this.legendData = option.legendData;
    }
    function getQueryString(name) {
        var reg = new RegExp('(^|&)' + name + '=([^&]*)(&|$)', 'i');
        var r = window.location.search.substr(1).match(reg);
        if (r != null) {
            return unescape(r[2]);
        }
        return null;
    }
    let typeArr = {};
    typeArr['all'] = '全部';
    typeArr['todo'] = '未完成';
    typeArr['done'] = '已完成';
    typeArr['delay'] = '延期';

    function openPlanCheckList(type, deptId, auditYear, title) {
        top.layer.open({
            type: 2,
            area: ['80%', '80%'],
            fix: false, //不固定
            maxmin: true,
            shadeClose: true,
            shade: 0.4,
            title: (title == undefined ? '' : title) + typeArr[type] + '项目',
            content: './plan-list.html?type=' + type + '&deptId=' + deptId + '&auditYear='+ auditYear,
            success: function (layero, index) {
                //窗口加载成功刷新frame
            },
            cancel: function () {
                //关闭窗口之后刷新frame
                // location.replace(location.href);
            },
            end: function () {
                //窗口销毁之后刷新frame
                // location.replace(location.href);
            }
        });
    }
    var gid;
    layui.use(['table'], function () {
        let table = layui.table;
        let roleIdList = userInfo.roleIdList;
        let deptName = userInfo.deptName;
        if ($.inArray(6, roleIdList) > -1) { //一般员工
            if (deptName.indexOf('中支') > -1) {
            } else if (deptName.indexOf('支行') > -1) {
            }
        } else if ($.inArray(1, roleIdList) > -1) { //管理员
            if (deptName.indexOf('中支') > -1) {
                $("#addBtn").removeClass("layui-hide");
                $("#delBtn").removeClass("layui-hide");
                $("#submitReportBtn").removeClass("layui-hide");
            } else if (deptName.indexOf('支行') > -1) {
            }
        } else if ($.inArray(13, roleIdList) > -1) { //超级管理员
        }
        gid = getQueryString("gid");
        table.render({
            elem: '#test',
            url: '/audit-api/planManage/planList?implementingAgencyId='+gid,
            toolbar: '#toolbarDemo',
            width:1200,
            xhrFields: {
                withCredentials: true
            },
            cols: [
                [/*{
                    type: 'checkbox', fixed: 'left'
                },*/{
                    field: 'id',
                    hide:true
                },{
                    field: 'project_code',
                    title: '项目编号',
                    width: 120
                }, {
                    field: 'project_name',
                    title: '项目名称',
                    width: 120
                }, {
                    field: 'agency_name',
                    title: '实施机构',
                    width: 120
                }, {
                    field: 'audit_object_name',
                    title: '审计对象',
                    width: 120,
                }, {
                    field: 'audit_nature_name',
                    title: '审计性质',
                    width: 180,
                }, {
                    field: 'audit_year',
                    title: '年度',
                    width: 120,
                }, {
                    field: 'rectify_situation_name',
                    title: '整改方案',
                    width: 120,
                }, {
                    field: 'risk_assessment_name',
                    title: '风险评估',
                    width: 120,
                }, {
                    field: 'problem_severity_name',
                    title: '严重程度',
                    width: 120,
                }, {
                    field: 'status',
                    title: '状态',
                    width: 80,
                    templet: (data) => {
                        let temp;
                        let text;
                        if (undefined == data.status || data.status == 1005) {
                            text = '<span>待审核</span>';
                        } else if (data.status == 1006) {
                            text = '<span style="color: #28ff34">已驳回</span>';
                        } else if (data.status == 1007) {
                            text = '<span style="color: red">已批准</span>';
                        }
                        temp = '<div>' + text + '</div>'
                        return temp;
                    }
                }, {
                    field: '',
                    title: '操作',
                    width: 240,
                    templet: function (res) {
                        var temp = `<span class="layui-btn layui-btn-normal layui-btn-mini" onclick="editPage_('编辑问题信息','../system/auditManagement/plan-management-edit.html','500','500','` + res.id + `', 'readOnly')" >查看</span>`
                        return temp;
                    }
                    // sort: true
                },]
            ],
            page: true,
            parseData: function (res) { //res 即为原始返回的数据
                return {
                    "code": res.code, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.data.total, //解析数据长度
                    "data": res.data.records //解析数据列表
                };
            },
            page: 1,
            limit: 10,
            request: {
                pageName: 'current', //页码的参数名称，默认：page
                limitName: 'size' //每页数据量的参数名，默认：limit
            },
            done: function (res, curr, count) {
            }
        });
        //监听头工具栏事件
        table.on('toolbar(test)', function(obj){
            var checkStatus = table.checkStatus(obj.config.id)
                ,data = checkStatus.data; //获取选中的数据
            switch(obj.event){
                case 'add':
                    layer.msg('添加');
                    break;
                case 'update':
                    if(data.length === 0){
                        layer.msg('请选择一行');
                    } else if(data.length > 1){
                        layer.msg('只能同时编辑一个');
                    } else {
                        layer.alert('编辑 [id]：'+ checkStatus.data[0].id);
                    }
                    break;
                case 'del':
                    if(data.length === 0){
                        layer.msg('请选择一行');
                    } else {
                        var ids = '';
                        data.forEach((item, index)=>{
                            if(index==0){
                                ids = item.id;
                            }else{
                                ids += ","+item.id;
                            }
                        });
                        $.ajax({
                            url: "/audit-api/planManage/deletePlan",
                            dataType: "json",
                            type: "post",
                            data: {"ids": ids},
                            success: function (res) {
                                table.reload('test', {
                                    page: 1
                                });
                            }
                        });
                        layer.msg('删除');
                    }
                    break;
                case 'editContent':
                    x_admin_show('提交汇总报告','plan-statistic-report-content.html?gid='+gid,'600','460');
                    break;
            };
        });
    });
</script>
<script>
    function editPage_(title, url, w, h, id, readOnly) {
        if (title == null || title == '') {
            title = false;
        }
        ;
        if (url == null || url == '') {
            url = "404.html";
        }
        ;
        if (w == null || w == '') {
            w = ($(window).width() * 0.9);
        }
        ;
        if (h == null || h == '') {
            h = ($(window).height() - 50);
        }
        ;
        layer.open({
            type: 2,
            area: [w + 'px', h + 'px'],
            fix: false, //不固定
            maxmin: true,
            shadeClose: true,
            shade: 0.4,
            title: title,
            content: url,
            success: function (layero, index) {
                //窗口加载成功刷新frame
                // location.replace(location.href);
                let body = layer.getChildFrame('body', index);
                let iframeWin = layero.find('iframe')[0];
                let readOnlyData = body.find('#readOnlyData');
                let inputData = body.find('#inputData');
                readOnlyData.val(readOnly);
                inputData.val(id);
                iframeWin.contentWindow.initEntryInfo();
            },
            cancel: function () {
                //关闭窗口之后刷新frame
                // location.replace(location.href);
            },
            end: function () {
                //窗口销毁之后刷新frame
                // location.replace(location.href);
            }
        });
    }
</script>
</html>