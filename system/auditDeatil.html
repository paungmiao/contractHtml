<!DOCTYPE html>
<html class="x-admin-sm" lang="en" xmlns:th="http://www.w3.org/1999/html">

<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="../css/font.css">
    <link rel="stylesheet" href="../css/xadmin.css">
    <link rel="stylesheet" href="../layui/css/layui.css">
    <link rel="stylesheet" href="../css/JCheck.css">
    <script type="text/javascript" src="../js/jqery/jquery-3.4.1.js"></script>
    <script type="text/javascript" src="../layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../js/xadmin.js"></script>
    <script type="text/javascript" src="../js/jwt.js"></script>
    <script type="text/javascript" src="../js/cookie.js"></script>
    <script src="../js/JCheck.js"></script>
    <script src="../js/echarts/echarts.min.js?v=1.0.4" charset="utf-8"></script>
</head>

<style type="text/css">
    .nav {
        width: 90%;
    }

    .nav .layui-input {
        border: none;
    }

    .time .layui-form-label {
        width: 95px;
    }

    .time .layui-input-block {
        margin-left: 125px;
    }

    .submit {
        text-align: center;
    }

    .position {
        position: absolute;
        right: 20px;
        top: 55px;
    }

    .position > .showMsg {
        position: absolute;
        right: 60px;
        text-align: center;
    }

    .position > .showMsg > label {
        text-align: center;
    }

    .position > .showMsg > span {
        font-size: 18px;
    }

    .formShow .layui-input, .formShow .layui-textarea {
        border: none;
    }

    .formShow .layui-form-label {
        width: 96px;
    }

    .formShow .layui-input-block {
        margin-left: 126px;
    }

    .x-admin-sm .layui-input, .x-admin-sm .layui-select, .x-admin-sm .layui-textarea {
        height: 38px;
    }

    h3 {
        padding-left: 15px;
    }
</style>
<body>
<div class="x-body  layui-form" lay-filter="allForm">
    <fieldset class="layui-elem-field layui-field-title">
        <legend name="planName">2333</legend>
    </fieldset>
    <div class="layui-form" lay-filter="basicForm">
        <div class="layui-row layui-form nav">
            <div class="layui-col-md3">
                <label class="layui-form-label">项目编号：</label>
                <div class="layui-input-block">
                    <input class="layui-input" name="projectCode" value="">
                </div>
            </div>
            <div class="layui-col-md3">
                <label class="layui-form-label">项目年度：</label>
                <div class="layui-input-block">
                    <input class="layui-input" name="auditYear" value="">
                </div>
            </div>
            <div class="layui-col-md3">
                <label class="layui-form-label">实施机构：</label>
                <div class="layui-input-block">
                    <input class="layui-input" name="implementingAgencyId">
                </div>
            </div>
            <div class="layui-col-md3">
                <label class="layui-form-label">审计对象：</label>
                <div class="layui-input-block">
                    <input class="layui-input" name="auditObjectId">
                </div>
            </div>
        </div>
        <div class="layui-row layui-form-item nav">
            <div class="layui-col-md3">
                <label class="layui-form-label">计划时长：</label>
                <div class="layui-input-block">
                    <input class="layui-input" name="planTime">
                </div>
            </div>
            <div class="layui-col-md3">
                <label class="layui-form-label">已用时长：</label>
                <div class="layui-input-block">
                    <input class="layui-input" name="costTime" id="costTime">
                </div>
            </div>
            <div class="layui-col-md3">
                <label class="layui-form-label">整改情况：</label>
                <div class="layui-input-block">
                    <input class="layui-input" name="rectifySituationId">
                </div>
            </div>
            <div class="layui-col-md3">
                <label class="layui-form-label">创建日期：</label>
                <div class="layui-input-block">
                    <input class="layui-input" name="createdTime">
                </div>
            </div>
        </div>
    </div>
    <div class="position">
<!--            <span class="layui-btn">更改状态</span>-->
            <span ></span>
        <div class="showMsg">
                    <label class="layui-form-label">项目状态</label>
                    <span id="statusName"></span>
        </div>
    </div>
    <!-- tab -->
    <div class="layui-tab layui-tab-brief">
        <ul class="layui-tab-title">
            <li class="layui-this">基本信息</li>
            <li>资料清单</li>
            <li>项目节点</li>
            <li class="completeForm layui-hide">完善信息</li>
            <li class="reportForm layui-hide">整改结果</li>
            <li class="rollbackForm layui-hide">驳回反馈</li>
            <li class="auditAdminUserForm layui-hide">完善信息（指派负责人）</li>
        </ul>
        <div class="layui-tab-content">
            <!-- 基本信息 -->
            <div class="layui-tab-item layui-show formShow layui-form" lay-filter="extendForm">
                <div class="layui-form-item">
                    <label class="layui-form-label">开始时间：</label>
                    <div class="layui-input-block">
                        <input class="layui-input" name="startTime" value="2020-2-9">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">出现频次：</label>
                    <div class="layui-input-block">
                        <input class="layui-input" value="">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">整改部门负责人：</label>
                    <div class="layui-input-block">
                        <input class="layui-input" name="impAdminId" value="">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">整改负责人：</label>
                    <div class="layui-input-block">
                        <input class="layui-input" name="rectifyMan" value="">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">项目类型：</label>
                    <div class="layui-input-block">
                        <input class="layui-input" name="projectType" value="">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">审计性质：</label>
                    <div class="layui-input-block">
                        <input class="layui-input" name="auditNatureId" value="">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">问题词条：</label>
                    <div class="layui-input-block">
                        <input class="layui-input" name="questionEntryId" value="">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">问题定性：</label>
                    <div class="layui-input-block">
                        <input class="layui-input" name="problemCharacterization" value="">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">审计依据：</label>
                    <div class="layui-input-block">
                        <input class="layui-input" name="auditBasis" value="">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">审计分类：</label>
                    <div class="layui-input-block">
                        <input class="layui-input" name="auditClassificationId" value="">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">审计经验：</label>
                    <div class="layui-input-block">
                        <input class="layui-input" name="auditingExperience" value="">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">风险评估：</label>
                    <div class="layui-input-block">
                        <input class="layui-input" riskAssessmentId value="">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">问题描述：</label>
                    <div class="layui-input-block">
                        <textarea class="layui-textarea" name="problemDescription" value=""></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">可能影响：</label>
                    <div class="layui-input-block">
                        <textarea class="layui-textarea" name="mayAffect" value=""></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">整改建议：</label>
                    <div class="layui-input-block">
                        <textarea class="layui-textarea" name="rectificationSuggestions" value=""></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">整改措施：</label>
                    <div class="layui-input-block">
                        <textarea class="layui-textarea" name="rectifyWay" value=""></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">整改结果：</label>
                    <div class="layui-input-block">
                        <textarea class="layui-textarea" name="rectifyResult" value="整改结果整改结果"></textarea>
                    </div>
                </div>

            </div>
            <!-- 资料清单 -->
            <div class="layui-tab-item">
                <table class="layui-table x-admin" id="documentList" lay-data="{id:'documentList'}">

                </table>
            </div>
            <!-- 项目节点 -->
            <div class="layui-tab-item">
                <table class="layui-table x-admin" id="flowTaskHistory" lay-data="{id:'flowTaskHistory'}">

                </table>
            </div>
            <!-- 完善信息  -->
            <div class="layui-tab-item layui-form completeForm layui-hide" lay-filter="completeForm">
                <h2>完善信息</h2>
                <hr/>
                <div class="layui-row layui-form-item">
                    <div class="layui-col-md6">
                        <label class="layui-form-label">整改负责人：</label>
                        <div class="layui-input-block">
                            <select class="layui-select" name="auditUserId" id="auditUserId">
                                <option value="">请选择整改负责人</option>
                            </select>
<!--                            <input class="layui-input" name="auditUserId">-->

                        </div>
                    </div>
                    <div class="layui-col-md6 time">
                        <label class="layui-form-label">计划整改时长：</label>
                        <div class="layui-input-block">
                            <input class="layui-input" id="planTime" placeholder="单位（天）" type="number"  min="0.5" max="100.0" step="0.5" name="planTime">
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">整改措施：</label>
                    <div class="layui-input-block">
                        <textarea class="layui-textarea" name="rectifyWay"></textarea>
                    </div>
                </div>
                <div class="layui-form-item submit  layui-file">
                    <label class="layui-form-label">上传文档：</label>
                    <div class="layui-input-block">
                        <input type="hidden" name="fileUri">
                        <input type="hidden" name="taskId">
                        <input type="hidden" name="taskName">
                        <input type="hidden" name="bizKey">
                        <input type="hidden" name="uploadUser">
                        <span class="layui-btn file-btn" name="file-btn" style="float: left;"><i class="layui-icon">&#xe681;</i>上传</span>
                        <span name="uploadName" style="float: left;"></span>
                    </div>
                </div>
                <div class="layui-form-item submit ">
                    <button class="layui-btn " lay-filter="completeSubmit" lay-submit="">
                        <i class="layui-icon">&#xe605;</i>提交
                    </button>
                </div>
            </div>
            <!-- 整改结果  -->
            <div class="layui-tab-item layui-form reportForm layui-hide" lay-filter="reportForm">
                <h2>整改结果</h2>
                <hr/>
                <div class="layui-form-item">
                    <label class="layui-form-label">整改结果：</label>
                    <div class="layui-input-block">
                        <textarea class="layui-textarea" name="rectifyResult"></textarea>
                    </div>
                </div>
                <div class="layui-form-item submit  layui-file">
                    <label class="layui-form-label">上传文档：</label>
                    <div class="layui-input-block">
                        <input type="hidden" name="fileUri">
                        <input type="hidden" name="taskId">
                        <input type="hidden" name="taskName">
                        <input type="hidden" name="bizKey">
                        <input type="hidden" name="uploadUser">
                        <span class="layui-btn  file-btn" name="file-btn" style="float: left;"><i class="layui-icon">&#xe681;</i>上传</span>
                        <span name="uploadName" style="float: left;"></span>
                    </div>
                </div>
                <div class="layui-form-item submit ">
                    <button class="layui-btn " lay-filter="reportSubmit" lay-submit>
                        <i class="layui-icon">&#xe605;</i>提交
                    </button>
                </div>
            </div>
            <!-- 驳回反馈  -->
            <div class="layui-tab-item layui-form rollbackForm  layui-hide" lay-filter="rollbackForm">
                <h2>驳回反馈</h2>
                <hr/>
                <div class="layui-form-item">
                    <label class="layui-form-label">驳回反馈：</label>
                    <div class="layui-input-block">
                        <textarea class="layui-textarea" name="rollbackRemarks"></textarea>
                    </div>
                </div>
            </div>
            <!-- 任务指派  -->
            <div class="layui-tab-item layui-form auditAdminUserForm  layui-hide" lay-filter="auditAdminUserForm">
                <h2>完善信息（实施任务指派）</h2>
                <hr/>
                <div class="layui-form-item">
                    <label class="layui-form-label">审计对象领导：</label>
                    <div class="layui-input-block">
                            <select class="layui-select" name="impUserId" id="auditAdminId" lay-filter="required">
                            </select>
                    </div>
                    <div class="layui-form-item submit ">
                        <button class="layui-btn " lay-filter="impUserSubmit" lay-submit>
                            <i class="layui-icon">&#xe605;</i>提交
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!--</div>-->
<script type="text/javascript">

    var count = 0;
    let bizKey = getQueryString("bizKey")
    let bizName = getQueryString("bizName")
    let taskId = getQueryString("taskId")
    let auditStatus = getQueryString("auditStatus")
    // let auditStatus = 1002
    layui.use(['table', 'element', 'laydate', 'form', 'upload'], function () {
        var element = layui.element;
        var table = layui.table;
        var laydate = layui.laydate;
        var form = layui.form;
        var upload = layui.upload;
        $("[name='bizKey']").val(bizKey);
        $("[name='bizName']").val(bizName);
        $("[name='taskId']").val(taskId);
        $("[name='uploadUser']").val(userInfo.username);
        $('.nav input').attr('disabled', 'disabled');
        $('.formShow input').attr('disabled', 'disabled');
        $('.formShow textarea').attr('disabled', 'disabled');


        // $(".completeForm").removeClass("layui-hide")
        // $(".reportForm").removeClass("layui-hide")
        // $(".rollbackForm").removeClass("layui-hide")
        // $(".submit").removeClass("layui-hide")
        let opinionStatus=1000
        let opinionUser = 1;
        if (auditStatus == 1002) { // 实施领导指派负责人
            $(".auditAdminUserForm").removeClass("layui-hide")
            $(".submit").removeClass("layui-hide")
        }else if (auditStatus == 1005) { // 通过计划 -> 完善计划 有提交
            $(".completeForm").removeClass("layui-hide")
            $(".submit").removeClass("layui-hide")
            layui.use('form',()=>{
                let form = layui.form;
                $.ajax({
                    url:'/audit-api/task/dept/normal/user',
                    headers:createAuthorizationTokenHeader(),
                    data:{
                        bizKey:bizKey,
                        deptId:userInfo.deptId
                    },
                    async:false,
                    success:(res)=>{
                        let optionHtml = '<option >请选择整改负责人</option>';
                        if(res.code==0){
                            for (let i in res.data){
                                optionHtml+='<option value="'+res.data[i].userId+'">'+res.data[i].username+'</option>'
                            }
                            $("#auditUserId").empty().append(optionHtml);
                            form.render('select')
                        }
                    }
                })
            })
        }else if (auditStatus == 1006) { // 审核整改计划 没提交
            $(".completeForm").removeClass("layui-hide")
        }else if (auditStatus == 1009) { //提交整改结果 有提交
            $(".reportForm").removeClass("layui-hide")
            $(".submit").removeClass("layui-hide")
        }else if (auditStatus == 1010 || auditStatus == 1011) { // 审核整改结果 无提交
            $(".reportForm").removeClass("layui-hide")
        }else if (auditStatus == 1007) { // 被驳回，完善计划
            $(".submit").removeClass("layui-hide")
            $(".completeForm").removeClass("layui-hide")
            $(".rollbackForm").removeClass("layui-hide")
        }else if (auditStatus == 1012 || auditStatus==1004) { // 被驳回
            $(".rollbackForm").removeClass("layui-hide")
        }else if (auditStatus > 1010) { // 被驳回，完善整改 有提交
            $(".reportForm").removeClass("layui-hide")
            $(".submit").removeClass("layui-hide")
        }

        //执行实例
        var uploadInst = upload.render({
            elem: '.file-btn' //绑定元素
            , url: '/audit-api/file/upload',//上传接口
            field: 'file',
            accept: 'file',
            size: 1024 * 50, // 单位kb
            data: {
                bizKey: bizKey
            }
            , done: function (res, index, upload) {
                //上传成功毕回调
                if (res.code == 0) {
                    let data = res.data;
                    $("[name='uploadName']").text(data.substr(data.lastIndexOf('/') + 1));
                    $("[name='fileUri']").val(data);
                    $(".file-btn").text('重新上传');
                }
                console.log(res)
            }
            , error: function () {
                //请求异常回调
            }
        });
        $.ajax({
            url: "/audit-api/planManage/detail/" + bizKey,
            async: false,
            type: 'get',
            contentType:"application/x-www-form-urlencoded; charset=UTF-8",
            headers: createAuthorizationTokenHeader(),
            success: function (res) {
                let status = res.data.status;
                switch(status) {
                    case '1001':
                        $("#statusName").text('正在实施')
                        break;
                    case '1002':
                        $("#statusName").text('实施结束')
                        break;
                    case '1003':
                        $("#statusName").text('已归档')
                        break;
                    default:
                        $("#statusName").text('正在实施')
                }
                $("[name='planName']").text(res.data.projectName);
                form.val('allForm', res.data)
            },
            error: function (error) {
                top.layer.msg('请检查网络连接', {icon: 2})
            }
        }).then((res)=>{
            let opinionStatus=1000
            let opinionUser = 1;
            let type = 0;// 0计划，1项目
            if (auditStatus == 1007) { // 被驳回，完善计划
                opinionStatus=1003
                type=0;
                opinionUser=res.data.impAdminId;
            }else if (auditStatus > 1010) { // 被驳回，完善整改 有提交
                opinionStatus=1003
                type=1;
                opinionUser=res.data.impAdminId;
            }
            else if(auditStatus==1004) { // 被驳回
                type=0;
                opinionUser=res.data.impUserId;
                opinionStatus=1004
            }else if (auditStatus==1002){
                $.ajax({
                    url:'/audit-api/task/dept/normal/user',
                    headers:createAuthorizationTokenHeader(),
                    data:{
                        bizKey:bizKey,
                        deptId:res.data.auditObjectId,
                        roleName:'管理员'
                    },
                    async:false,
                    success:(res)=>{
                        let optionHtml = '<option >请选择实施负责人</option>';
                        if(res.code==0){
                            for (let i in res.data){
                                optionHtml+='<option value="'+res.data[i].userId+'">'+res.data[i].username+'</option>'
                            }
                            $("#auditAdminId").empty().append(optionHtml);
                            form.render('select')
                        }
                    }
                })
                form.on('submit(impUserSubmit)',(data)=>{
                    let auditAdminId = form.val('auditAdminUserForm').auditAdminId
                    if(!auditAdminId){
                        return top.layer.msg('请指派实施负责人',{icon:2});
                    }
                    $.post('/audit-api/task/commitAuditAdminUser',{
                        bizKey:bizKey,
                        auditAdminId:auditAdminId
                    },function (res) {
                        if(res.code==0 && res.data){
                            top.layer.msg('提交成功',{icon:1})
                        }else{
                            top.layer.msg(res.msg,{icon:2})
                        }

                    })
                })
            }
            $.get('/audit-api/planInfo/user/opinion',{
                userId:opinionUser,
                type:type,
                statusUser:opinionStatus,
                planId:bizKey
            },function (data) {
                if(data.code==0&&data.data){
                    form.val('rollbackForm',{
                        rollbackRemarks:data.data.opinion
                    })
                }
            })
        })

        $.ajax({
            url: "/audit-api/task/plan/costdays/" + bizKey,
            type: 'get',
            async:false,
            headers: createAuthorizationTokenHeader(),
            success: function (res) {
                let days =0;
                if(res.data!=null){
                    days=res.data.days==undefined?0:res.data.days
                }
                $("#costTime").val(days)
            },
            error: function (error) {
                top.layer.msg('请检查网络连接', {icon: 2})
            }
        })

        table.render({
            elem: '#documentList',
            url: '/audit-api/file/biz/files',
            xhrFields: {
                withCredentials: true
            },
            cols: [
                [{
                    type: 'numbers',
                    title: '序号',
                    width: 80
                }, {
                    field: 'fileName',
                    title: '文件名',
                    templet: (res) => {
                        let fileUrlDiv = '<div><a  target="view_window" title="点击下载附件" style="text-decoration: underline;color: #00b7ee" href="javascript:void(0);" onclick="openNewWindow(\''+ res.fileUrl+'\')">' + res.fileName + '</a></div>'
                        return fileUrlDiv;
                    }
                }, {
                    field: 'uploadUser',
                    title: '操作人员',
                    width: 200,
                }, {
                    field: 'createdTime',
                    title: '创建日期',
                    width: 300,
                },]
            ],
            page: false,
            where: {
                bizKey: bizKey
            }
        });
        /**
         * 提交整改结果
         */
        form.on('submit(reportSubmit)', function (res) {
            //提交完善信息
            let reportForm = form.val('reportForm');
            let nextStatus = auditEnum[auditStatus].agree;
            reportForm['status']=nextStatus;
            reportForm['id']=bizKey;
            $.ajax({
                url:'/audit-api/task/submitReport',
                type:'post',
                data:JSON.stringify(reportForm),
                headers:createAuthorizationTokenHeader(),
                contentType:'application/json;charset=utf8',
                dataType:'json',
                async: false,
                success:function (res) {
                    if(res.code==0 && res.data){
                        top.layer.msg("操作成功",{icon:1})
                        $(".submit").addClass("layui-hide");
                    }else{
                        top.layer.msg(res.msg,{icon:2})
                    }
                },
                error:function () {
                    layer.msg('请检查网络连接',{icon:2})
                }
            })
            return false;
        })
        //提交完善信息
        form.on('submit(completeSubmit)', function (res) {
            //提交完善信息
            let completeForm = form.val('completeForm');
            // let nextStatus = auditEnum[auditStatus].agree;
            let nextStatus = 1006;
            nextStatus['status']=nextStatus;
            nextStatus['id']=bizKey;
            $.ajax({
                url:'/audit-api/task/completePlan',
                type:'post',
                data:JSON.stringify(completeForm),
                headers:createAuthorizationTokenHeader(),
                contentType:'application/json;charset=utf8',
                dataType:'json',
                async: false,
                success:function (res) {
                    if(res.code==0 && res.data){
                        top.layer.msg("操作成功",{icon:1})
                        $(".submit").addClass("layui-hide");
                    }
                },
                error:function () {
                    layer.msg('请检查网络连接',{icon:2})
                }
            })
            return false;
        })


        table.render({
            elem: '#flowTaskHistory',
            url: '/audit-api/task/taskHistory',
            xhrFields: {
                withCredentials: true
            },
            cols: [
                [
                    {
                        field: 'taskId',
                        title: '节点编号',
                        width: 80
                    }, {
                    field: 'taskName',
                    title: '节点名称',
                    width: 200,
                }, {
                    field: 'startTime',
                    title: '开始时间',
                    width: 200,
                }, {
                    field: 'assigneeName',
                    title: '责任人',
                    width: 300,
                }, {
                    field: 'endTime',
                    title: '办理时间',
                    width: 300,
                }]
            ],
            page: false,
            parseData: function (res) { //res 即为原始返回的数据
                return {
                    "code": res.code, //解析接口状态
                    "msg": res.msg, //解析提示文本
                    "count": res.data.length, //解析数据长度
                    "data": res.data //解析数据列表
                };
            },
            headers: createAuthorizationTokenHeader(),
            where: {
                processDefKey: 'auditApply',
                businessId: bizKey
            }
        });


        // //时间选择器
        // laydate.render({
        //     elem: '#planTime'
        //     , trigger: "click"
        // });
    });
function openNewWindow(url) {
    console.log('http://'+url)
    window.open('http://'+url,"_blank ");
}
</script>
</body>
</html>