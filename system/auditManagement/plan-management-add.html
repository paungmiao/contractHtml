<!DOCTYPE html>
<html class="x-admin-sm" xmlns:th="http://www.w3.org/1999/html">

<head>
    <link rel="stylesheet" href="../../css/font.css">
    <link rel="stylesheet" href="../../css/xadmin.css">
    <link rel="stylesheet" href="../../layui/css/layui.css">
    <link rel="stylesheet" href="../../css/JCheck.css">
    <script type="text/javascript" src="../../js/jqery/jquery-3.4.1.js"></script>
    <script type="text/javascript" src="../../layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="../../js/xadmin.js"></script>
    <script type="text/javascript" src="../../js/jwt.js"></script>
    <script type="text/javascript" src="../../js/cookie.js"></script>
    <script src="../../js/JCheck.js"></script>
</head>

<body>
<div class="x-body">
    <form class="layui-form" lay-filter="planAddForm">
        <input name="implementingAgencyId" type="hidden" id="implementingAgencyId">
        <input name="createdBy" type="hidden" id="createdBy">
        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">*</span>审计年度:
            </label>
            <div class="layui-input-inline">
                <input name="auditYear" class="layui-input" style="width:200px" autocomplete="off" placeholder="请输入审计年度" id="start">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">*</span>实施机构:
            </label>
            <div class="layui-input-inline">
                <input class="layui-input" id="implementingAgencyName" name="implementingAgencyName" disabled />
            </div>
            <div class="layui-input-inline">
                <select id="impAdminSelect" name="impAdminId">
                </select>
            </div>
            <div class="layui-input-inline">
                <select id="impUserSelect" name="impUserId">
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">*</span>审计对象:
            </label>
            <div class="layui-input-inline">
                <select id="auditObjectIdSelect" name="auditObjectId" lay-filter="one_cate">
                </select>
            </div>
            <div class="layui-input-inline">
                <select id="auditAdminSelect" name="auditAdminId">
                </select>
            </div>
            <div class="layui-input-inline">
                <select id="auditUserSelect" name="auditUserId">
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">*</span>项目类型:
            </label>
            <div class="layui-input-inline">
                <select id="projectTypeSelect" name="projectType">
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">*</span>审计性质:
            </label>
            <div class="layui-input-inline">
                <select id="auditNatureIdSelect" name="auditNatureId">
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">*</span>问题词条:
            </label>
            <div class="layui-input-inline">
                <select id="questionEntryIdSelect" name="questionEntryId">
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">*</span>问题严重程度:
            </label>
            <div class="layui-input-inline">
                <select id="problemSeverityIdSelect" name="problemSeverityId">
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">*</span>整改情况:
            </label>
            <div class="layui-input-inline">
                <select id="rectifySituationIdSelect" name="rectifySituationId">
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">*</span>项目名称:
            </label>
            <div class="layui-input-inline">
                <input name="projectName" type="text" style="width:200px" lay-verify="required|projectName" placeholder="请输入项目名称"
                       autocomplete="off" class="layui-input" value="">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">*</span>问题定性:
            </label>
            <div class="layui-input-inline">
                <input name="problemCharacterization" type="text" style="width:200px" placeholder="请输入问题定性" autocomplete="off" class="layui-input" value="">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">*</span>问题描述:
            </label>
            <div class="layui-input-inline">
                <input name="problemDescription" type="text" style="width:200px" placeholder="请输入问题描述" autocomplete="off" class="layui-input" value="">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                <span class="x-red">*</span>可能影响:
            </label>
            <div class="layui-input-inline">
                <input name="mayAffect" type="text" style="width:200px" placeholder="请输入可能影响" autocomplete="off" class="layui-input" value="">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">
                <span class="x-red">*</span>整改建议:
            </label>
            <div class="layui-input-block">
                <textarea name="rectificationSuggestions" placeholder="整改建议" class="layui-textarea"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                审计依据:
            </label>
            <div class="layui-input-inline">
                <input name="auditBasis" type="text" style="width:200px" placeholder="请输入审计依据" autocomplete="off" class="layui-input" value="">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                审计分类:
            </label>
            <div class="layui-input-inline">
                <select id="auditClassificationIdSelect" name="auditClassificationId">
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                审计经验:
            </label>
            <div class="layui-input-inline">
                <input name="auditingExperience" type="text" style="width:200px" placeholder="请输入审计经验" autocomplete="off" class="layui-input" value="">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">
                风险评估:
            </label>
            <div class="layui-input-inline">
                <select id="riskAssessmentIdSelect" name="riskAssessmentId">
                </select>
            </div>
        </div>


        <div class="layui-input-inline">
            <label for="L_repass" class="layui-form-label">
            </label>
            <button class="layui-btn" lay-submit lay-filter="addPlanCheckList">
                <i class="layui-icon">&#xe605;</i>添加
            </button>
        </div>
        <div class="layui-input-inline">
            <label for="L_repass" class="layui-form-label">
            </label>
            <a class="layui-btn" onclick="off()">
                <i class="layui-icon">&#x1007;</i>取消
            </a>
        </div>

    </form>
</div>
<script>

    layui.use(['form', 'layer'], function () {
        if(!userInfo){
           return top.layer.msg("用户身份信息已失效",{icon:2})
        }
        //赋值
        $("#implementingAgencyId").val(userInfo.deptId);
        $("#implementingAgencyName").val(userInfo.deptName);
        $("#createdBy").val(userInfo.userId);

        let form = layui.form
        let layer = layui.layer;
        {
            $.ajax({
                url: "/audit-api/planManage/getUsersByRoleNameAndDept?deptId=" + userInfo.deptId + "&roleName=管理员",
                dataType: "json",
                type: "get",
                async:false,
                headers:createAuthorizationTokenHeader(),
                success: function (resp) {
                    if (resp && 0 == resp.code) {
                        let data = resp.data;
                        let options = [];
                        options.push('<option value="" >请选择实施机构管理员</option>')
                        data.forEach((Obj) => {
                            let option = '<option value="' + Obj.userId + '">' + Obj.username + '</option>';
                            options.push(option);
                        })
                        $("#impAdminSelect").empty().append(options.join(""));
                    }
                }
            });
            $.ajax({
                url: "/audit-api/planManage/getUsersByRoleNameAndDept?deptId=" + userInfo.deptId + "&roleName=一般用户",
                dataType: "json",
                type: "get",
                async:false,
                headers: {
                    Authorization: window.sessionStorage.getItem('Authorization')
                },
                success: function (resp) {
                    if (resp && 0 == resp.code) {
                        let data = resp.data;
                        let options = [];
                        options.push('<option value="" >请选择实施机构一般用户</option>')
                        data.forEach((Obj) => {
                            let option = '<option value="' + Obj.userId + '">' + Obj.username + '</option>';
                            options.push(option);
                        })
                        $("#impUserSelect").empty().append(options.join(""));
                    }
                }
            });
        }
        $.ajax({
            url: "/audit-api/planManage/getAuditObject?deptId="+userInfo.deptId,
            dataType: "json",
            type: "get",
            async:false,
            headers: createAuthorizationTokenHeader(),
            success: function (resp) {
                if (resp && 0 == resp.code) {
                    let data = resp.data;
                    let options = [];
                    options.push('<option value="" >请选择审计对象</option>')
                    data.forEach((Obj) => {
                        let option = '<option value="' + Obj.deptId + '">' + Obj.name + '</option>';
                        options.push(option);
                    })
                    $("#auditObjectIdSelect").empty().append(options.join(""));
                }
            }
        })
        $.ajax({
            url: "/audit-api/planManage/selectEntryByCategoryId?categoryId=3",
            dataType: "json",
            type: "get",
            async:false,
            success: function (resp) {
                if (resp && 0 == resp.code) {
                    let data = resp.data;
                    let options = [];
                    options.push('<option value="" >请选择项目类型</option>')
                    data.forEach((Obj) => {
                        let option = '<option value="' + Obj.id + '">' + Obj.name + '</option>';
                        options.push(option);
                    })
                    $("#projectTypeSelect").empty().append(options.join(""));
                }
            }
        });
        $.ajax({
            url: "/audit-api/planManage/selectEntryByCategoryId?categoryId=4",
            dataType: "json",
            type: "get",
            async:false,
            success: function (resp) {
                if (resp && 0 == resp.code) {
                    let data = resp.data;
                    let options = [];
                    options.push('<option value="" >请选择审计性质</option>')
                    data.forEach((Obj) => {
                        let option = '<option value="' + Obj.id + '">' + Obj.name + '</option>';
                        options.push(option);
                    })
                    $("#auditNatureIdSelect").empty().append(options.join(""));
                }
            }
        });
        $.ajax({
            url: "/audit-api/planManage/selectEntryByCategoryId?categoryId=8",
            dataType: "json",
            type: "get",
            async:false,
            success: function (resp) {
                if (resp && 0 == resp.code) {
                    let data = resp.data;
                    let options = [];
                    options.push('<option value="" >请选择问题词条</option>')
                    data.forEach((Obj) => {
                        let option = '<option value="' + Obj.id + '">' + Obj.name + '</option>';
                        options.push(option);
                    })
                    $("#questionEntryIdSelect").empty().append(options.join(""));
                }
            }
        });
        $.ajax({
            url: "/audit-api/planManage/selectEntryByCategoryId?categoryId=5",
            dataType: "json",
            type: "get",
            async:false,
            success: function (resp) {
                if (resp && 0 == resp.code) {
                    let data = resp.data;
                    let options = [];
                    options.push('<option value="" >请选择问题严重程度</option>')
                    data.forEach((Obj) => {
                        let option = '<option value="' + Obj.id + '">' + Obj.name + '</option>';
                        options.push(option);
                    })
                    $("#problemSeverityIdSelect").empty().append(options.join(""));
                }
            }
        });
        $.ajax({
            url: "/audit-api/planManage/selectEntryByCategoryId?categoryId=6",
            dataType: "json",
            type: "get",
            async: false,
            success: function (resp) {
                if (resp && 0 == resp.code) {
                    let data = resp.data;
                    let options = [];
                    options.push('<option value="" >请选择问题整改情况</option>')
                    data.forEach((Obj) => {
                        let option = '<option value="' + Obj.id + '">' + Obj.name + '</option>';
                        options.push(option);
                    })
                    $("#rectifySituationIdSelect").empty().append(options.join(""));
                }
            }
        });
        $.ajax({
            url: "/audit-api/planManage/selectEntryByCategoryId?categoryId=7",
            dataType: "json",
            type: "get",
            async: false,
            success: function (resp) {
                if (resp && 0 == resp.code) {
                    let data = resp.data;
                    let options = [];
                    options.push('<option value="" >请选择审计分类</option>')
                    data.forEach((Obj) => {
                        let option = '<option value="' + Obj.id + '">' + Obj.name + '</option>';
                        options.push(option);
                    })
                    $("#auditClassificationIdSelect").empty().append(options.join(""));
                }
            }
        });
        $.ajax({
            url: "/audit-api/planManage/selectEntryByCategoryId?categoryId=9",
            dataType: "json",
            type: "get",
            async: false,
            success: function (resp) {
                if (resp && 0 == resp.code) {
                    let data = resp.data;
                    let options = [];
                    options.push('<option value="" >请选择风险评估</option>')
                    data.forEach((Obj) => {
                        let option = '<option value="' + Obj.id + '">' + Obj.name + '</option>';
                        options.push(option);
                    })
                    $("#riskAssessmentIdSelect").empty().append(options.join(""));
                }
            }
        });
        form.verify({
            projectName: function (value, dom) {
                if (value.length > 128) {
                    return '项目名称不能超过128个字符！'
                }
            }
        })
        form.render('select');
        //监听提交
        form.on('submit(addPlanCheckList)', function (data) {
            let formData = form.val("planAddForm");
            $.ajax({
                url: '/audit-api/planManage/saveOrEditPlan',
                type: 'POST',
                dataType: "json",
                data: formData,
                success: function (resp) {
                    //发异步，把数据提交给php
                    if (0 == resp.code) {
                        layer.alert("增加成功", {icon: 6}, function () {
                            // 获得frame索引
                            var index = parent.layer.getFrameIndex(window.name);
                            //关闭当前frame
                            parent.layer.close(index);
                            // 可以对父窗口进行刷新
                            x_admin_father_reload();
                        });
                    } else {
                        layer.alert("操作失败 " + resp.msg, {icon: 2}, function () {

                        })
                    }

                },
                error: function (error) {
                    layer.alert(error)
                }
            })
            return false;
        });
        form.on('select(one_cate)', function (data) {
            let deptId = data['value'];
            $.ajax({
                url: "/audit-api/planManage/getUsersByRoleNameAndDept?deptId=" + deptId + "&roleName=管理员",
                dataType: "json",
                type: "get",
                async: false,
                headers: {
                    Authorization: window.sessionStorage.getItem('Authorization')
                },
                success: function (resp) {
                    if (resp && 0 == resp.code) {
                        let data = resp.data;
                        let options = [];
                        options.push('<option value="" >请选择审计对象管理员</option>')
                        data.forEach((Obj) => {
                            let option = '<option value="' + Obj.userId + '">' + Obj.username + '</option>';
                            options.push(option);
                        })
                        $("#auditAdminSelect").empty().append(options.join(""));
                    }
                }
            });
            $.ajax({
                url: "/audit-api/planManage/getUsersByRoleNameAndDept?deptId=" + deptId + "&roleName=一般用户",
                dataType: "json",
                type: "get",
                async: false,
                headers: {
                    Authorization: window.sessionStorage.getItem('Authorization')
                },
                success: function (resp) {
                    if (resp && 0 == resp.code) {
                        let data = resp.data;
                        let options = [];
                        options.push('<option value="" >请选择审计对象一般用户</option>')
                        data.forEach((Obj) => {
                            let option = '<option value="' + Obj.userId + '">' + Obj.username + '</option>';
                            options.push(option);
                        })
                        $("#auditUserSelect").empty().append(options.join(""));
                    }
                }
            });
            form.render("select");
        });

    });
    layui.use('laydate', function () {
        let laydate = layui.laydate;

        //执行一个laydate实例
        laydate.render({
            elem: '#start', //指定元素
            type: "year"
        });

    });
</script>
<script>
    function off() {
        let index = parent.layer.getFrameIndex(window.name); //获取当前窗口的name
        parent.layer.close(index);		//关闭窗口
    }
</script>

</body>

</html>